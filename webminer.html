<!DOCTYPE html>
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Duino-Coin | WebMiner</title>
      <link rel="icon" href="https://github.com/revoxhere/duino-coin/blob/master/Resources/duco.png?raw=true" type="image/png"/>
      <link rel="shortcut icon" href="https://github.com/revoxhere/duino-coin/blob/master/Resources/duco.png?raw=true" type="image/png"/>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
      <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script src="https://cdn.rawgit.com/h2non/jsHashes/master/hashes.js"></script>
      <style>
        body {
          background: url(https://i.imgur.com/qy2BpmG.jpg) no-repeat;
          background-size: cover;
          background-attachment: fixed;
        }
        h1, h2, h3, h4, h5, h6, p, label, div {
          color: white !important;
        }
        a {
          color: #bdc3c7;
        }
        input {
          background-color: none !important;
          color: white !important;
          border-style: none !important;
        }
        .custButton {
          border-style: none !important;
          color: white !important;
        }
        .container21 {
          box-shadow: 0 0 1rem 0 rgba(0, 0, 0, .2);   
          border-radius: 6px;
          border-top: 100px;
          padding: 1em;
          background-color: rgba(255, 255, 255, .001);
            
          backdrop-filter: blur(30px);
        }
      </style>
      <script>
      	var speed = "slow";
        $("html, body").hide();
        $(document).ready(function() {
            $("html, body").fadeIn(speed, function() {
                $("a[href], button[href]").click(function(event) {
                    var url = $(this).attr("href");
                    if (url.indexOf("#") == 0 || url.indexOf("javascript:") == 0) return;
                    event.preventDefault();
                    $("html, body").fadeOut(speed, function() {
                        window.location = url;
                    });
                });
            });
        });

        window.onload = function(){
        let SHA1 = new Hashes.SHA1
        let sharecounter = 0;
        var hash_count = 0;
        let badsharecounter = 0;
        let message;

        let login = document.querySelector('.login');
        let algo = document.querySelector('.algo'); 

        let ws = new WebSocket("ws://163.172.179.54:15808");

        const sleep = (milliseconds) => {
            return new Promise(resolve => setTimeout(resolve, milliseconds))
        }

        ws.onmessage = function (event) {
          let server_message = event.data;
          console.log("Server: " + server_message)

          if (server_message.includes("1.")) {
            document.getElementById("loginstatus").innerHTML = "Proxy server is online";
          }

          else if (server_message == "BAD") {
            badsharecounter++;
            hash_count = hash_count / 1000;

            hash_count = hash_count / 1000;
            document.getElementById("sharecount").innerHTML = " ✔️ Accepted: " + sharecounter + "<br> ❌ Rejected: " + badsharecounter + "<br> ⚡ Hashrate: ~" + hash_count + " kH/s";

            hash_count = 0;

            sleep(50).then(() => {
              var username = document.getElementById("username").value;
              ws.send("JOB," + username);
            })
          }

          else if (server_message == "GOOD") {
            sharecounter++;
            hash_count = hash_count / 1000;
            
            document.getElementById("sharecount").innerHTML = " ✔️ Accepted: " + sharecounter + "<br> ❌ Rejected: " + badsharecounter + "<br> ⚡ Hashrate: ~" + hash_count + " kH/s";

            hash_count = 0;

            sleep(50).then(() => {
              var username = document.getElementById("username").value;
              ws.send("JOB," + username);
            })
          }
          else if (server_message == "INVU") {
            document.getElementById("loginstatus").innerHTML = "This user doesn't exist. Refresh the page and try again.";
          }

          else if (server_message.length > 64) { // If we receive long data which means its job
            content = String(server_message)
            let job = content.split(',');
            let difficulty = job[2];
            let result;

            for(result = 0; result < (100 * difficulty + 1); result++){
              let ducos1 = SHA1.hex(job[0] + result); // calculate sha1 hash
              hash_count++;
              if(job[1] == ducos1){ // and if correct result is found
                
                console.log("Miner: Share found: " + result);
                ws.send(result); // send the result to the server
                break;
              }
             }
           }
        }
        
        login.onclick = function (event) {
        	document.getElementById("sharecount").innerHTML = "Please wait...";
			var username = document.getElementById("username").value;
	        sleep(50).then(() => {
            	ws.send("JOB," + username);;
          })
        }}
    </script>
    </head>
    <body>
		<section id="herosection" style="height: 50em">
		    <div class="hero-body">
		        <div class="columns is-centered">
		            <div class="column is-5-tablet is-4-desktop is-30-widescreen">
		                <div class="box container21">
		                    <h1 class="title">Duino-Coin Miner</h1>
						    <table>
						    	<tr>
						    		<label for="" class="label">Username</label>
							    	<div id="amountInput" class="field">
							        	<p class="control has-icons-left has-icons-right">
							        		<input class="container21 input" id="username" type="text" placeholder="Username">
							        		<span class="icon is-small is-left">
							        			<i class="fas fa-user"></i>
							        		</span>
							        	</p>
							        </div>
						            <button style="width:100%; text-align:center;" class="button container21 custButton login">Start mining</button>
						        </tr>
						    </table>
						   	<br>
						   	<div class="box container21">
							    <h1 class="title is-4" id="miningstatus">Status</h1>
							    <p id="loginstatus">Connecting...</p>
							    <p id="sharecount"></p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
		<div class="content has-text-centered">
        <p>Duino-Coin WebMiner made with <i class="fa fa-code"></i>, <i class="fa fa-coffee"></i> and <i class="fa fa-heart"></i> by revox 2020<br>Background photo by revox 2020</p>
      </div>
    </body>
</html>
